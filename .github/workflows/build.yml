# SaveTheDate - CI/CD Pipeline
#
# Automatise le build et déploiement des apps pour chaque client
# Déclenché quand un fichier config.json est modifié dans /clients/

name: Build and Deploy App

on:
  push:
    paths:
      - 'clients/*/config.json'
    branches:
      - main
  workflow_dispatch:
    inputs:
      client_slug:
        description: 'Client slug to build'
        required: true
        type: string
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android

env:
  NODE_VERSION: '18'
  RUBY_VERSION: '3.0'
  JAVA_VERSION: '17'

jobs:
  # Détecte quel client a été modifié
  detect-client:
    runs-on: ubuntu-latest
    outputs:
      client_slug: ${{ steps.detect.outputs.client_slug }}
      should_build: ${{ steps.detect.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect modified client
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "client_slug=${{ inputs.client_slug }}" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            CLIENT=$(git diff --name-only HEAD~1 HEAD | grep 'clients/' | head -1 | cut -d'/' -f2)
            if [ -n "$CLIENT" ]; then
              echo "client_slug=$CLIENT" >> $GITHUB_OUTPUT
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Print detected client
        run: |
          echo "Client: ${{ steps.detect.outputs.client_slug }}"
          echo "Should build: ${{ steps.detect.outputs.should_build }}"

  # Valide la configuration du client
  validate:
    needs: detect-client
    if: needs.detect-client.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate config.json
        run: |
          CLIENT_SLUG="${{ needs.detect-client.outputs.client_slug }}"
          CONFIG_FILE="./clients/$CLIENT_SLUG/config.json"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "❌ Config file not found: $CONFIG_FILE"
            exit 1
          fi
          
          # Valider le JSON
          if ! jq empty "$CONFIG_FILE" 2>/dev/null; then
            echo "❌ Invalid JSON in $CONFIG_FILE"
            exit 1
          fi
          
          # Vérifier les champs requis
          EVENT_ID=$(jq -r '.event_id' "$CONFIG_FILE")
          if [ "$EVENT_ID" == "null" ] || [ -z "$EVENT_ID" ]; then
            echo "❌ Missing event_id in config"
            exit 1
          fi
          
          echo "✅ Config validation passed"

      - name: Check required assets
        run: |
          CLIENT_SLUG="${{ needs.detect-client.outputs.client_slug }}"
          ASSETS_DIR="./clients/$CLIENT_SLUG/assets"
          
          if [ ! -f "$ASSETS_DIR/icon_1024.png" ]; then
            echo "⚠️ Warning: icon_1024.png not found"
          fi
          
          if [ ! -f "$ASSETS_DIR/splash.png" ]; then
            echo "⚠️ Warning: splash.png not found"
          fi

  # Build iOS
  build-ios:
    needs: [detect-client, validate]
    if: |
      needs.detect-client.outputs.should_build == 'true' && 
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios' || github.event.inputs.platform == '')
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: mobile/ios

      - name: Install dependencies
        run: |
          cd mobile
          npm ci
          cd ios
          pod install

      - name: Setup certificates
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
        run: |
          cd mobile/ios
          bundle exec fastlane sync_certificates

      - name: Build and upload to App Store
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
          BUNDLE_ID: com.savethedate.event.${{ needs.detect-client.outputs.client_slug }}
        run: |
          CLIENT_SLUG="${{ needs.detect-client.outputs.client_slug }}"
          CONFIG_FILE="./clients/$CLIENT_SLUG/config.json"
          
          APP_NAME=$(jq -r '.branding.app_name // .title' "$CONFIG_FILE")
          EVENT_ID=$(jq -r '.event_id' "$CONFIG_FILE")
          
          cd mobile/ios
          bundle exec fastlane build_and_upload \
            app_name:"$APP_NAME" \
            bundle_id:"$BUNDLE_ID" \
            event_id:"$EVENT_ID"

  # Build Android
  build-android:
    needs: [detect-client, validate]
    if: |
      needs.detect-client.outputs.should_build == 'true' && 
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android' || github.event.inputs.platform == '')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: mobile/android

      - name: Install dependencies
        run: |
          cd mobile
          npm ci

      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > mobile/android/app/release.keystore

      - name: Build and upload to Play Store
        env:
          GOOGLE_PLAY_JSON_KEY: ${{ secrets.GOOGLE_PLAY_JSON_KEY }}
          BUNDLE_ID: com.savethedate.event.${{ needs.detect-client.outputs.client_slug }}
        run: |
          CLIENT_SLUG="${{ needs.detect-client.outputs.client_slug }}"
          CONFIG_FILE="./clients/$CLIENT_SLUG/config.json"
          
          APP_NAME=$(jq -r '.branding.app_name // .title' "$CONFIG_FILE")
          EVENT_ID=$(jq -r '.event_id' "$CONFIG_FILE")
          
          cd mobile/android
          bundle exec fastlane build_and_upload \
            app_name:"$APP_NAME" \
            bundle_id:"$BUNDLE_ID" \
            event_id:"$EVENT_ID"

  # Génère le QR code et notifie
  post-build:
    needs: [detect-client, build-ios, build-android]
    if: always() && needs.detect-client.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate QR code
        run: |
          CLIENT_SLUG="${{ needs.detect-client.outputs.client_slug }}"
          
          # Installer qrencode
          sudo apt-get install -y qrencode
          
          # Générer le QR code
          ./scripts/generate_qr.sh "$CLIENT_SLUG"

      - name: Upload QR code artifact
        uses: actions/upload-artifact@v4
        with:
          name: qr-code-${{ needs.detect-client.outputs.client_slug }}
          path: clients/${{ needs.detect-client.outputs.client_slug }}/qr_code.png

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            Build ${{ job.status }} for client: ${{ needs.detect-client.outputs.client_slug }}
            iOS: ${{ needs.build-ios.result }}
            Android: ${{ needs.build-android.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
